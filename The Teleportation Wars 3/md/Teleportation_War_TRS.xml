<?xml version="1.0" encoding="utf-8"?>
<mdscript name="TradeReceiverUpdate" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="D:/x4 extract 2.0b1/libraries/md.xsd">
  <cues>
    <cue name="TRS_Main">
      <conditions>
        <check_any>
          <event_cue_signalled cue="md.Setup.GameStart" />
          <event_player_created/>
          <event_cue_signalled/>
        </check_any>
      </conditions>

<!-- Timer to do scan at an interval (does not currently work.....) -->
      <cues>
        <!-- <cue name="TRS_Main_PullDataTimer" instantiate="true" checkinterval="10min" checktime="player.age + 30s" namespace="this">
          <actions>
            <signal_cue cue="TRS_Main_ManageSubs"/>
          </actions>
        </cue> -->

<!-- Activate when a new station is built -->
        <!-- <cue name="TRS_Main_StationBuilt" instantiate="true" namespace="this">
          <conditions>
            <event_object_built_station space="player.galaxy"/>
          </conditions>
          <actions>
            <signal_cue_instantly cue="TRS_Main_ManageSubs" param="event.param.sector"/>
          </actions>          
        </cue> -->

<!-- Activate when a satellite is deployed -->
        <cue name="TRS_Main_SatDeployed" instantiate="true" namespace="this">
          <conditions>
            <event_satellite_launched space="player.galaxy"/>
            <check_value value="event.param2.isplayerowned"/>
          </conditions>
          <actions>
            <!-- <find_object name="$Habmodulescan" space="player.galaxy" owner="faction.player" multiple="false" macro="[macro.hab_arg_l_01_macro, macro.hab_par_l_01_macro, macro.hab_tel_l_01_macro]"/>
            <do_if value="$Habmodulescan.exists" > -->
              <signal_cue_instantly cue="TRS_Main_ManageSubs" param="event.param2.sector"/>
            <!-- </do_if> -->
            <!-- <remove_value name="$Habmodulescan"/> -->
          </actions>          
        </cue>



<!-- Activate when a satellite is destroyed -->
        <cue name="TRS_Main_Destroyed" instantiate="true" namespace="this">
          <conditions>
            <event_player_owned_destroyed/>
            <check_value value="event.param.macro == macro.eq_arg_satellite_09_macro or event.param.macro == macro.eq_arg_satellite_10_macro"/>
          </conditions>
          <actions>
            <signal_cue_instantly cue="TRS_Main_ManageSubs" param="event.param.sector"/>
          </actions>
        </cue>


<!-- This should activate after TIMER and after SAT DESTROYED/DEPLOYED -->
        <cue name="TRS_Main_ManageSubs" instantiate="true" namespace="this">
          <conditions>
            <event_cue_signalled/>
          </conditions>
          <delay exact="1s"/>
          <actions>
            <set_value name="$sector" exact="event.param"/>

<!-- SET MACRO TO MATCH OUR SPECIAL TRADE SATELLITE -->
            <find_object macro="macro.eq_arg_satellite_09_macro" owner="faction.player" multiple="true" functional="true" groupname="$sats" space="$sector"/>
            <find_object name="$Habmodulescan" space="player.galaxy" owner="faction.player" multiple="false" macro="[macro.hab_arg_l_01_macro, macro.hab_par_l_01_macro, macro.hab_tel_l_01_macro]"/>
            <do_if value="$Habmodulescan.exists" >
                <find_object macro="macro.eq_arg_satellite_10_macro" owner="faction.player" multiple="true" functional="true" groupname="$sats" space="$sector"/>
            </do_if>
            <do_if value="not $sats.count">
              <find_station multiple="true" name="$stations" space="$sector">
                <match owner="faction.player" negate="true"/>
              </find_station>

              <do_all exact="$stations.count" counter="$j">
                <do_if value="$stations.{$j}.haspermanenttradesubscription">
                  <remove_trade_subscription object="$stations.{$j}"/>
                </do_if>
              </do_all>
            </do_if>
            <do_else>
              <find_station multiple="true" name="$stations" space="$sector">
                <match owner="faction.player" negate="true"/>
              </find_station>

              <do_all exact="$stations.count" counter="$j">
                <do_if value="$stations.{$j}.relationto.{faction.player} ge 0 and not $stations.{$j}.haspermanenttradesubscription">
                  <add_trade_subscription object="$stations.{$j}"/>

                </do_if>
              </do_all>           
            </do_else>
            <remove_value name="$stations"/>
            <remove_value name="$sats"/>
            <remove_value name="$sector"/>
          </actions>
        </cue>
      </cues>
    </cue>  
  </cues>
</mdscript>